<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - Anime Store</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1828/1828466.png">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ðŸ”¥ CRISP LIVE CHAT SCRIPT ðŸ”¥ -->
    <script type="text/javascript">
        window.$crisp=[];
        window.CRISP_WEBSITE_ID="4457f464-2c5f-4cae-abdc-ee22ebe288e5";
        (function(){
            d=document;
            s=d.createElement("script");
            s.src="https://client.crisp.chat/l.js";
            s.async=1;
            d.getElementsByTagName("head")[0].appendChild(s);
        })();
    </script>

    <style>
        :root {
            --primary: #ff758c;
            --primary-dark: #ff5c77;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.85);
            --glass-strong: rgba(255, 255, 255, 0.95);
            --text: #444;
            --shadow: 0 10px 30px rgba(255, 117, 140, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }

        /* ANIMATED BACKGROUND (Matches Login Page) */
        body {
            background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            color: var(--text);
            padding-top: 70px; /* Space for Navbar */
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- NAVBAR --- */
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 50;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.5);
        }

        .logo { font-size: 1.4rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }

        /* HAMBURGER MENU ICON */
        .menu-btn {
            width: 45px; height: 45px;
            display: flex; align-items: center; justify-content: center;
            background: white; border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            cursor: pointer; transition: 0.3s; color: #555; font-size: 1.2rem;
        }
        .menu-btn:active { transform: scale(0.9); }

        /* --- MARQUEE BAR (ANNOUNCEMENT) --- */
        .marquee-box {
            width: 100%;
            background: rgba(255, 117, 140, 0.9);
            backdrop-filter: blur(5px);
            color: white;
            padding: 8px 0;
            z-index: 40;
            display: none; /* Hidden by default, JS enables it */
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }
        .marquee-content { font-weight: 500; font-size: 0.9rem; letter-spacing: 0.5px; display: flex; align-items: center; }

        /* --- SIDEBAR MENU (SLIDE IN) --- */
        .sidebar-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            backdrop-filter: blur(3px); z-index: 99;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }

        .sidebar {
            position: fixed; top: 0; right: -300px; width: 280px; height: 100%;
            background: var(--glass-strong);
            box-shadow: -5px 0 30px rgba(0,0,0,0.1);
            z-index: 100; padding: 25px;
            display: flex; flex-direction: column;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .sidebar.active { right: 0; }

        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 15px;
        }
        
        .nav-list { list-style: none; }
        .nav-list li { margin-bottom: 12px; }
        .nav-list a {
            text-decoration: none; color: #555;
            display: flex; align-items: center; gap: 15px;
            padding: 14px; border-radius: 15px;
            font-weight: 500; transition: 0.3s;
            background: rgba(255,255,255,0.6);
            border: 1px solid white;
        }
        .nav-list a.active, .nav-list a:active { background: #fff0f3; color: var(--primary); border-color: var(--primary); }

        /* --- MAIN CONTENT --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; transition: 0.3s; }
        
        .section-title {
            font-size: 1.4rem; font-weight: 700; color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
        }

        /* GRID SYSTEM */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        @media(min-width: 768px) { .grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; } }

        /* PRODUCT CARD */
        .card {
            background: var(--glass); border-radius: 20px; padding: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.6); position: relative; overflow: hidden;
        }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
        .card-img { width: 100%; height: 160px; object-fit: cover; border-radius: 15px; margin-bottom: 10px; background: white; }
        .tag {
            position: absolute; top: 10px; left: 10px; background: var(--primary); color: white;
            padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700;
        }
        .btn {
            width: 100%; padding: 12px; margin-top: 10px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 117, 140, 0.3);
        }

        /* ORDER LIST */
        .order-item {
            background: var(--glass); padding: 15px; border-radius: 15px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .b-pen { background: #fff3cd; color: #856404; }
        .b-pro { background: #d1ecf1; color: #0c5460; }
        .b-com { background: #d4edda; color: #155724; }

        /* MODAL */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-box {
            background: #fff; width: 100%; max-width: 450px; border-radius: 25px; padding: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2); animation: zoomIn 0.3s ease; max-height: 90vh; overflow-y: auto;
        }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        input, textarea {
            width: 100%; padding: 14px; margin-bottom: 12px; border: 2px solid #f0f0f0;
            border-radius: 12px; outline: none; background: #fafafa;
        }
        input:focus { border-color: var(--primary); background: white; }

        /* SECTIONS */
        .section { display: none; animation: fadeUp 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="logo"><i class="fa-solid fa-cloud-bolt"></i> AnimeStore</div>
        <div class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
    </nav>

    <!-- MARQUEE (ANNOUNCEMENT BAR) -->
    <div id="marqueeContainer" class="marquee-box">
        <div class="marquee-content">
            <i class="fa-solid fa-bullhorn" style="margin: 0 10px;"></i>
            <marquee id="marqueeText" scrollamount="6">Welcome to the store!</marquee>
        </div>
    </div>

    <!-- SIDEBAR MENU -->
    <div class="sidebar-overlay" onclick="toggleMenu()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div>
                <h4 id="userName" style="color:#333;">Guest</h4>
                <small id="userEmail" style="color:#888;">Login required</small>
            </div>
            <i class="fa-solid fa-xmark" onclick="toggleMenu()" style="font-size:1.4rem; color:#888;"></i>
        </div>
        <ul class="nav-list">
            <li><a href="#" onclick="nav('home')" class="active"><i class="fa-solid fa-store"></i> Shop Home</a></li>
            <li><a href="#" onclick="nav('orders')"><i class="fa-solid fa-box-open"></i> My Orders</a></li>
            <li><a href="#" onclick="nav('support')"><i class="fa-solid fa-headset"></i> Support</a></li>
            <li style="margin-top:20px;"><a href="#" onclick="logout()" style="color:#ff4d4d; border-color:#ffe6e6; background:#fff0f0;"><i class="fa-solid fa-power-off"></i> Logout</a></li>
        </ul>
        <div style="margin-top: auto; text-align: center; opacity: 0.7;">
            <img src="https://media.tenor.com/images/330558b3543d357e6b772478e5c45f44/tenor.gif" width="100">
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="container" id="mainContainer">
        
        <!-- 1. HOME -->
        <div id="home" class="section active">
            <div class="section-title"><i class="fa-solid fa-fire"></i> Trending</div>
            <div class="grid" id="productGrid"><p style="color:white;">Loading...</p></div>
        </div>

        <!-- 2. ORDERS -->
        <div id="orders" class="section">
            <div class="section-title"><i class="fa-solid fa-clock-rotate-left"></i> History</div>
            <div id="ordersContainer"></div>
        </div>

        <!-- 3. SUPPORT (TICKETS + CRISP) -->
        <div id="support" class="section">
            <div class="section-title"><i class="fa-regular fa-comments"></i> Support</div>
            
            <!-- Info about Live Chat -->
            <div class="card" style="margin-bottom:20px; background: #fff0f3; border: 1px solid var(--primary);">
                <h4 style="color:var(--primary); margin-bottom:5px;"><i class="fa-solid fa-comment-dots"></i> Live Chat Available</h4>
                <p style="font-size:0.9rem; color:#555;">Use the bubble icon in the bottom right corner for instant help!</p>
            </div>

            <!-- Create Ticket -->
            <div class="card" style="margin-bottom:20px;">
                <h4 style="margin-bottom:10px;">Or Create a Ticket</h4>
                <form id="ticketForm">
                    <textarea id="tMsg" rows="3" placeholder="Type issue..." required></textarea>
                    <button type="submit" class="btn">Send Ticket</button>
                </form>
            </div>
            
            <div id="ticketHistory"></div>
        </div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div id="checkoutModal" class="modal">
        <div class="modal-box">
            <div style="text-align:center; margin-bottom:15px;">
                <img id="c-img" src="" style="width:80px; height:80px; object-fit:cover; border-radius:15px;">
                <h3 id="c-name" style="margin-top:10px;">Item</h3>
                <h2 id="c-price" style="color:var(--primary);">$0.00</h2>
            </div>
            <form id="orderForm">
                <input type="hidden" id="c-id">
                <input type="text" id="fname" placeholder="Full Name" required>
                <input type="tel" id="fphone" placeholder="Phone Number" required>
                <input type="text" id="faddr" placeholder="Address" required>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button type="button" onclick="closeModal()" style="background:#eee; color:#555; width:40%; border:none; border-radius:12px;">Cancel</button>
                    <button type="submit" class="btn" style="margin-top:0;">Confirm COD</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SUCCESS POPUP -->
    <div id="successPop" class="modal">
        <div class="modal-box" style="text-align:center;">
            <img src="https://media.tenor.com/images/1c8e983422e6f2eb50f83651356dc5b1/tenor.gif" width="100" style="border-radius:50%; margin-bottom:15px;">
            <h3 style="color:var(--primary)">Success!</h3>
            <p style="color:#888;">Action completed.</p>
            <button onclick="document.getElementById('successPop').style.display='none'" class="btn" style="margin-top:15px;">Okay</button>
        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, where, orderBy, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ðŸ”¥ YOUR CONFIG KEYS ðŸ”¥
        const firebaseConfig = {
            apiKey: "AIzaSyCo6W6Tzze5IvgcblQGvRssZcIUNlS9gQ0",
            authDomain: "waisi-store.firebaseapp.com",
            databaseURL: "https://waisi-store-default-rtdb.firebaseio.com",
            projectId: "waisi-store",
            storageBucket: "waisi-store.firebasestorage.app",
            messagingSenderId: "670605149716",
            appId: "1:670605149716:web:1c3becc5e7aa4c9b328901"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let userId = "";

        // UI TOGGLES
        window.toggleMenu = () => {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }
        window.nav = (id) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            toggleMenu();
        }
        window.closeModal = () => document.getElementById('checkoutModal').style.display = 'none';
        window.logout = () => signOut(auth).then(() => window.location.href = "index.html");

        // AUTH & LISTENERS
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                document.getElementById('userEmail').innerText = user.email;
                document.getElementById('userName').innerText = user.email.split('@')[0];
                
                loadMarquee();
                loadProducts();
                loadOrders();
                loadTickets();
                
                // Set Crisp Email
                if(window.$crisp) $crisp.push(["set", "user:email", [user.email]]);
                
            } else {
                window.location.href = "index.html";
            }
        });

        // 1. MARQUEE LOGIC (SETTINGS)
        function loadMarquee() {
            onSnapshot(doc(db, "settings", "marquee"), (doc) => {
                if(doc.exists()) {
                    const data = doc.data();
                    const el = document.getElementById('marqueeContainer');
                    if(data.isEnabled && data.text) {
                        el.style.display = "block";
                        document.getElementById('marqueeText').innerText = data.text;
                        // Push content down slightly
                        document.getElementById('mainContainer').style.marginTop = "10px";
                    } else {
                        el.style.display = "none";
                        document.getElementById('mainContainer').style.marginTop = "0px";
                    }
                }
            });
        }

        // 2. LOAD PRODUCTS
        async function loadProducts() {
            const grid = document.getElementById('productGrid');
            const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            grid.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                grid.innerHTML += `
                    <div class="card">
                        ${p.tag ? `<div class="tag">${p.tag}</div>` : ''}
                        <img src="${p.image}" class="card-img">
                        <div style="font-weight:600; font-size:0.9rem; margin-bottom:5px;">${p.name}</div>
                        <div style="color:var(--primary); font-weight:700;">$${p.price}</div>
                        <button class="btn" onclick="buy('${d.id}', '${p.name}', ${p.price}, '${p.image}')">Buy</button>
                    </div>`;
            });
        }

        // 3. ORDER SYSTEM
        window.buy = (id, name, price, img) => {
            document.getElementById('c-id').value = id;
            document.getElementById('c-name').innerText = name;
            document.getElementById('c-price').innerText = "$" + price;
            document.getElementById('c-img').src = img;
            document.getElementById('checkoutModal').style.display = 'flex';
        }

        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerText = "Processing...";
            await addDoc(collection(db, "orders"), {
                userId: userId,
                productName: document.getElementById('c-name').innerText,
                total: document.getElementById('c-price').innerText.replace('$',''),
                fullName: document.getElementById('fname').value,
                phone: document.getElementById('fphone').value,
                address: document.getElementById('faddr').value,
                status: "Pending",
                createdAt: new Date()
            });
            closeModal();
            document.getElementById('successPop').style.display = 'flex';
            document.getElementById('orderForm').reset();
            btn.innerText = "Confirm COD";
        });

        function loadOrders() {
            onSnapshot(query(collection(db, "orders"), where("userId", "==", userId), orderBy("createdAt", "desc")), snap => {
                const div = document.getElementById('ordersContainer');
                div.innerHTML = "";
                snap.forEach(d => {
                    const o = d.data();
                    const cls = o.status == 'Pending' ? 'b-pen' : (o.status == 'Processing' ? 'b-pro' : 'b-com');
                    div.innerHTML += `
                        <div class="order-item">
                            <div><div style="font-weight:600">${o.productName}</div><small>$${o.total}</small></div>
                            <span class="badge ${cls}">${o.status}</span>
                        </div>`;
                });
                if(snap.empty) div.innerHTML = "<p style='color:white; text-align:center'>No orders yet.</p>";
            });
        }

        // 4. TICKETS
        document.getElementById('ticketForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "tickets"), {
                userId: userId,
                userEmail: auth.currentUser.email,
                message: document.getElementById('tMsg').value,
                reply: "",
                createdAt: new Date()
            });
            document.getElementById('tMsg').value = "";
            document.getElementById('successPop').style.display = 'flex';
        });

        function loadTickets() {
            onSnapshot(query(collection(db, "tickets"), where("userId", "==", userId), orderBy("createdAt", "desc")), snap => {
                const div = document.getElementById('ticketHistory');
                div.innerHTML = "";
                snap.forEach(d => {
                    const t = d.data();
                    div.innerHTML += `
                        <div style="background:var(--glass); padding:10px; border-radius:10px; margin-top:10px;">
                            <p>${t.message}</p>
                            ${t.reply ? `<p style="margin-top:5px; padding:5px; background:rgba(255,255,255,0.5); border-radius:5px; font-size:0.9rem; color:var(--primary);"><strong>Admin:</strong> ${t.reply}</p>` : ''}
                        </div>`;
                });
            });
        }
    </script>
</body>
</html>
