<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Waisi Store - Dashboard</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ðŸ”¥ CRISP LIVE CHAT SCRIPT ðŸ”¥ -->
    <script type="text/javascript">
        window.$crisp=[];
        window.CRISP_WEBSITE_ID="4457f464-2c5f-4cae-abdc-ee22ebe288e5";
        (function(){
            d=document;
            s=d.createElement("script");
            s.src="https://client.crisp.chat/l.js";
            s.async=1;
            d.getElementsByTagName("head")[0].appendChild(s);
        })();
    </script>

    <style>
        :root {
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --text-main: #111111;
            --text-muted: #777777;
            --accent: #000000;
            --border: #e6e6e6;
            --nav-height: 65px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: var(--nav-height); /* Space for bottom menu on mobile */
        }

        /* --- 1. SIDEBAR (Desktop Only) --- */
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid var(--border);
            height: 100vh;
            position: fixed;
            left: 0; top: 0;
            padding: 30px;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .logo-area {
            font-size: 1.5rem; font-weight: 800; letter-spacing: -0.5px;
            margin-bottom: 40px; display: flex; align-items: center; gap: 10px;
        }

        .nav-link {
            display: flex; align-items: center; gap: 15px;
            padding: 14px;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 5px;
            font-weight: 500;
            transition: 0.2s;
        }
        .nav-link:hover, .nav-link.active {
            background: var(--accent);
            color: white;
        }

        /* --- 2. MOBILE TOP HEADER --- */
        .mobile-header {
            display: none; /* Hidden on desktop */
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border); z-index: 90;
            align-items: center; justify-content: space-between; padding: 0 20px;
        }

        /* --- 3. BOTTOM NAVIGATION (Mobile Only) --- */
        .bottom-nav {
            display: none; /* Hidden on desktop */
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: white; border-top: 1px solid var(--border);
            z-index: 1000;
            justify-content: space-around; align-items: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
        }
        
        .b-nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #999; text-decoration: none; font-size: 0.7rem; gap: 4px;
            width: 100%; height: 100%;
        }
        .b-nav-item i { font-size: 1.3rem; margin-bottom: 2px; transition: 0.2s; }
        .b-nav-item.active { color: var(--accent); font-weight: 600; }
        .b-nav-item.active i { transform: translateY(-2px); }

        /* --- 4. MARQUEE BAR (ANNOUNCEMENT) --- */
        .marquee-box {
            width: 100%;
            background: var(--accent);
            color: white;
            padding: 10px 0;
            font-size: 0.9rem;
            display: none; /* Hidden by default, JS enables it */
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .marquee-content {
            display: flex; align-items: center;
        }
        .marquee-content i { margin: 0 15px; color: #ffeb3b; }

        /* --- MAIN CONTENT --- */
        .main-content {
            margin-left: 260px;
            padding: 40px;
        }

        /* --- PRODUCT CARDS --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .card {
            background: white; border: 1px solid var(--border); border-radius: 12px;
            overflow: hidden; transition: 0.2s;
        }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #f0f0f0; }
        .card-body { padding: 15px; }
        .btn {
            width: 100%; padding: 12px; background: var(--accent); color: white;
            border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
        }

        /* --- ORDER & TICKET LISTS --- */
        .list-item {
            background: white; padding: 15px; border-radius: 10px; border: 1px solid var(--border);
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .st-pen { background: #fff3cd; color: #856404; }
        .st-pro { background: #d1ecf1; color: #0c5460; }
        .st-com { background: #d4edda; color: #155724; }

        /* --- FULL SCREEN CHECKOUT --- */
        .checkout-modal {
            position: fixed; inset: 0; background: white; z-index: 2000;
            display: none; flex-direction: column; overflow-y: auto;
        }
        .c-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; background: white; z-index: 10;
        }
        .c-body { max-width: 800px; margin: 0 auto; width: 100%; padding: 20px; }
        input, textarea {
            width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd;
            border-radius: 8px; font-size: 1rem; outline: none;
        }
        input:focus { border-color: black; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            .sidebar { display: none; } /* Hide Desktop Sidebar */
            .mobile-header { display: flex; } /* Show Top Logo */
            .bottom-nav { display: flex; } /* Show Bottom Menu */
            
            .main-content { margin-left: 0; padding: 15px; padding-top: 80px; }
            
            .grid { grid-template-columns: 1fr 1fr; gap: 15px; }
            .card-img { height: 150px; }
            
            .marquee-box { border-radius: 4px; margin-bottom: 15px; }
        }

        .section { display: none; animation: fade 0.3s; }
        .section.active { display: block; }
        @keyframes fade { from{opacity:0;} to{opacity:1;} }

    </style>
</head>
<body>

    <!-- 1. MOBILE TOP HEADER (Logo + Logout) -->
    <div class="mobile-header">
        <div style="font-weight:800; font-size:1.3rem; display:flex; align-items:center; gap:8px;">
            <i class="fa-solid fa-store"></i> Waisi Store
        </div>
        <button onclick="logout()" style="background:none; border:none; color:#d9534f; font-size:1.2rem;">
            <i class="fa-solid fa-power-off"></i>
        </button>
    </div>

    <!-- 2. DESKTOP SIDEBAR -->
    <div class="sidebar">
        <div class="logo-area"><i class="fa-solid fa-store"></i> Waisi Store</div>
        
        <div style="margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid #eee;">
            <small style="color:#888;">Logged in as:</small>
            <div id="userName" style="font-weight:600;">Guest</div>
        </div>

        <nav>
            <a href="#" onclick="nav('home')" class="nav-link active" id="d-home"><i class="fa-solid fa-shop"></i> Shop</a>
            <a href="#" onclick="nav('orders')" class="nav-link" id="d-orders"><i class="fa-solid fa-box"></i> Orders</a>
            <a href="#" onclick="nav('support')" class="nav-link" id="d-support"><i class="fa-solid fa-headset"></i> Support</a>
        </nav>

        <a href="#" onclick="logout()" class="nav-link" style="margin-top:auto; color:#d9534f;"><i class="fa-solid fa-power-off"></i> Logout</a>
    </div>

    <!-- 3. MAIN CONTENT -->
    <div class="main-content">

        <!-- ðŸ”¥ MARQUEE (ANNOUNCEMENT) AREA ðŸ”¥ -->
        <div id="marqueeContainer" class="marquee-box">
            <div class="marquee-content">
                <i class="fa-solid fa-bullhorn"></i>
                <marquee id="marqueeText" scrollamount="6">Welcome to Waisi Store!</marquee>
            </div>
        </div>
        
        <!-- HOME (Shop) -->
        <div id="home" class="section active">
            <h2 style="margin-bottom:20px;">Latest Products</h2>
            <div class="grid" id="productGrid"><p>Loading...</p></div>
        </div>

        <!-- ORDERS -->
        <div id="orders" class="section">
            <h2 style="margin-bottom:20px;">My Orders</h2>
            <div id="ordersContainer"></div>
        </div>

        <!-- SUPPORT -->
        <div id="support" class="section">
            <h2 style="margin-bottom:20px;">Support Tickets</h2>
            <div style="background:white; padding:20px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
                <form id="ticketForm">
                    <textarea id="tMsg" rows="3" placeholder="Type your issue..." required></textarea>
                    <button type="submit" class="btn">Send Ticket</button>
                </form>
            </div>
            <div id="ticketHistory"></div>
        </div>
    </div>

    <!-- 4. BOTTOM NAVIGATION (Mobile) -->
    <div class="bottom-nav">
        <a href="#" onclick="nav('home')" class="b-nav-item active" id="m-home">
            <i class="fa-solid fa-shop"></i>
            <span>Shop</span>
        </a>
        <a href="#" onclick="nav('orders')" class="b-nav-item" id="m-orders">
            <i class="fa-solid fa-box"></i>
            <span>Orders</span>
        </a>
        <a href="#" onclick="nav('support')" class="b-nav-item" id="m-support">
            <i class="fa-solid fa-headset"></i>
            <span>Support</span>
        </a>
    </div>

    <!-- CHECKOUT FULL SCREEN -->
    <div id="checkoutModal" class="checkout-modal">
        <div class="c-header">
            <h3>Checkout</h3>
            <i class="fa-solid fa-xmark" onclick="closeCheckout()" style="font-size:1.5rem;"></i>
        </div>
        <form id="orderForm" class="c-body">
            <div style="text-align:center; margin-bottom:30px;">
                <img id="c-img" src="" style="width:100px; height:100px; border-radius:10px; object-fit:cover;">
                <h3 id="c-name" style="margin-top:10px;">Product</h3>
                <h2 id="c-price">$0.00</h2>
            </div>
            
            <input type="hidden" id="c-id">
            <label>Name</label>
            <input type="text" id="fname" required>
            <label>Phone</label>
            <input type="tel" id="fphone" required>
            <label>Address</label>
            <textarea id="faddr" rows="3" required></textarea>
            
            <button type="submit" class="btn" style="padding:15px; font-size:1.1rem; margin-top:10px;">Confirm Order (COD)</button>
        </form>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, where, orderBy, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ðŸ”¥ CONFIG ðŸ”¥
        const firebaseConfig = {
            apiKey: "AIzaSyCo6W6Tzze5IvgcblQGvRssZcIUNlS9gQ0",
            authDomain: "waisi-store.firebaseapp.com",
            databaseURL: "https://waisi-store-default-rtdb.firebaseio.com",
            projectId: "waisi-store",
            storageBucket: "waisi-store.firebasestorage.app",
            messagingSenderId: "670605149716",
            appId: "1:670605149716:web:1c3becc5e7aa4c9b328901"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = "";

        // NAVIGATION LOGIC
        window.nav = (id) => {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Update Desktop Sidebar
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if(document.getElementById('d-'+id)) document.getElementById('d-'+id).classList.add('active');

            // Update Mobile Bottom Nav
            document.querySelectorAll('.b-nav-item').forEach(l => l.classList.remove('active'));
            if(document.getElementById('m-'+id)) document.getElementById('m-'+id).classList.add('active');

            window.scrollTo(0,0);
        }

        window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
        window.buy = (id, name, price, img) => {
            document.getElementById('c-id').value = id;
            document.getElementById('c-name').innerText = name;
            document.getElementById('c-price').innerText = "$" + price;
            document.getElementById('c-img').src = img;
            document.getElementById('checkoutModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        window.closeCheckout = () => {
            document.getElementById('checkoutModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // AUTH & DATA
        onAuthStateChanged(auth, user => {
            if(user) {
                userId = user.uid;
                document.getElementById('userName').innerText = user.email.split('@')[0];
                loadMarquee(); // <-- ADDED THIS
                loadProducts();
                loadOrders();
                loadTickets();
                if(window.$crisp) $crisp.push(["set", "user:email", [user.email]]);
            } else {
                window.location.href = "index.html";
            }
        });

        // ðŸ”¥ MARQUEE LOGIC ðŸ”¥
        function loadMarquee() {
            onSnapshot(doc(db, "settings", "marquee"), (doc) => {
                if(doc.exists()) {
                    const data = doc.data();
                    const el = document.getElementById('marqueeContainer');
                    if(data.isEnabled && data.text) {
                        el.style.display = "block";
                        document.getElementById('marqueeText').innerText = data.text;
                    } else {
                        el.style.display = "none";
                    }
                }
            });
        }

        // LOAD PRODUCTS
        async function loadProducts() {
            const grid = document.getElementById('productGrid');
            const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            grid.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                grid.innerHTML += `
                    <div class="card">
                        <img src="${p.image}" class="card-img">
                        <div class="card-body">
                            <div style="font-weight:600; margin-bottom:5px;">${p.name}</div>
                            <div style="font-weight:700; margin-bottom:10px;">$${p.price}</div>
                            <button class="btn" onclick="buy('${d.id}', '${p.name}', ${p.price}, '${p.image}')">Buy Now</button>
                        </div>
                    </div>`;
            });
            if(snap.empty) grid.innerHTML = "<p>No items found.</p>";
        }

        // ORDER SYSTEM
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.innerText = "Processing...";
            await addDoc(collection(db, "orders"), {
                userId: userId,
                userEmail: auth.currentUser.email,
                productName: document.getElementById('c-name').innerText,
                total: document.getElementById('c-price').innerText.replace('$',''),
                fullName: document.getElementById('fname').value,
                phone: document.getElementById('fphone').value,
                address: document.getElementById('faddr').value,
                status: "Pending",
                createdAt: new Date()
            });
            alert("Order Placed!");
            closeCheckout();
            btn.innerText = "Confirm Order (COD)";
            nav('orders');
        });

        function loadOrders() {
            onSnapshot(query(collection(db, "orders"), where("userId", "==", userId), orderBy("createdAt", "desc")), snap => {
                const div = document.getElementById('ordersContainer');
                div.innerHTML = "";
                snap.forEach(d => {
                    const o = d.data();
                    let badge = "st-pen";
                    if(o.status == "Processing") badge = "st-pro";
                    if(o.status == "Completed") badge = "st-com";
                    
                    div.innerHTML += `
                        <div class="list-item">
                            <div>
                                <b>${o.productName}</b><br>
                                <small style="color:#777;">$${o.total}</small>
                            </div>
                            <span class="badge ${badge}">${o.status}</span>
                        </div>`;
                });
            });
        }

        // TICKET SYSTEM
        document.getElementById('ticketForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "tickets"), {
                userId: userId,
                userEmail: auth.currentUser.email,
                message: document.getElementById('tMsg').value,
                reply: "",
                createdAt: new Date()
            });
            document.getElementById('tMsg').value = "";
        });

        function loadTickets() {
            onSnapshot(query(collection(db, "tickets"), where("userId", "==", userId), orderBy("createdAt", "desc")), snap => {
                const div = document.getElementById('ticketHistory');
                div.innerHTML = "";
                snap.forEach(d => {
                    const t = d.data();
                    div.innerHTML += `
                        <div style="background:white; border:1px solid #eee; padding:15px; border-radius:10px; margin-bottom:10px;">
                            <div style="background:#f9f9f9; padding:10px; border-radius:8px;">You: ${t.message}</div>
                            ${t.reply ? `<div style="background:#000; color:white; padding:10px; border-radius:8px; margin-top:5px;">Admin: ${t.reply}</div>` : 
                            `<small style="color:#888; display:block; margin-top:5px;">Waiting for reply...</small>`}
                        </div>`;
                });
            });
        }
    </script>
</body>
</html>