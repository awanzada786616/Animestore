<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Control Panel</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1828/1828466.png">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --bg: #f4f7fc; 
            --white: #fff; 
            --primary: #ff758c; 
            --text: #333; 
            --shadow: 0 5px 20px rgba(0,0,0,0.05);
        }
        
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
        body { background: var(--bg); display: flex; height: 100vh; overflow: hidden; color: var(--text); }

        /* SIDEBAR */
        .sidebar { 
            width: 260px; background: var(--white); padding: 2rem; 
            border-right: 1px solid #eee; display:flex; flex-direction:column; 
        }
        .brand { font-size: 1.5rem; font-weight: 600; color: var(--primary); margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; }
        
        .menu a { 
            display: flex; align-items: center; gap: 12px; padding: 14px; 
            color: #666; text-decoration: none; border-radius: 12px; 
            margin-bottom: 8px; transition:0.3s; font-weight: 500;
        }
        .menu a:hover, .menu a.active { background: #fff0f3; color: var(--primary); }
        
        /* CONTENT */
        .main { flex: 1; padding: 2rem; overflow-y: auto; }
        .header { margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; }
        
        .card { 
            background: var(--white); padding: 25px; border-radius: 20px; 
            box-shadow: var(--shadow); margin-bottom: 20px; animation: fadeIn 0.4s ease;
        }
        
        /* FORMS */
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #666; font-weight: 500; }
        input, textarea, select { 
            width: 100%; padding: 12px; border: 1px solid #eee; 
            border-radius: 10px; margin-bottom: 15px; outline:none; transition: 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--primary); }
        
        .btn { 
            padding: 12px 25px; background: var(--primary); color: white; 
            border: none; border-radius: 10px; cursor: pointer; font-weight: 600;
            transition: 0.3s;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        th { color: #999; font-weight: 500; font-size: 0.85rem; }
        
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .st-Pending { background: #fff3cd; color: #856404; }
        .st-Processing { background: #d1ecf1; color: #0c5460; }
        .st-Completed { background: #d4edda; color: #155724; }

        /* SECTIONS */
        .section { display: none; }
        .section.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* TOGGLE SWITCH FOR MARQUEE */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="brand"><i class="fa-solid fa-cube"></i> AdminPanel</div>
        <nav class="menu">
            <a href="#" onclick="nav('dash', this)" class="active"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
            <a href="#" onclick="nav('add', this)"><i class="fa-solid fa-plus-circle"></i> Add Product</a>
            <a href="#" onclick="nav('orders', this)"><i class="fa-solid fa-box-open"></i> Manage Orders</a>
            <a href="#" onclick="nav('tickets', this)"><i class="fa-solid fa-envelope"></i> Tickets</a>
            <a href="#" onclick="nav('settings', this)"><i class="fa-solid fa-sliders"></i> App Settings</a>
        </nav>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">
        <div class="header">
            <h2 id="pageTitle">Overview</h2>
            <div style="font-size: 0.9rem; color: #888;">Administrator</div>
        </div>
        
        <!-- 1. DASHBOARD STATS -->
        <div id="dash" class="section active">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:20px;">
                <div class="card" style="text-align:center;">
                    <i class="fa-solid fa-users" style="font-size:2rem; color:#a0c4ff; margin-bottom:10px;"></i>
                    <h3 id="c-users">0</h3>
                    <p style="color:#888;">Total Users</p>
                </div>
                <div class="card" style="text-align:center;">
                    <i class="fa-solid fa-bag-shopping" style="font-size:2rem; color:#bdb2ff; margin-bottom:10px;"></i>
                    <h3 id="c-orders">0</h3>
                    <p style="color:#888;">Total Orders</p>
                </div>
                <div class="card" style="text-align:center;">
                    <i class="fa-solid fa-comments" style="font-size:2rem; color:#ffc6ff; margin-bottom:10px;"></i>
                    <h3 id="c-tickets">0</h3>
                    <p style="color:#888;">Pending Tickets</p>
                </div>
            </div>
        </div>

        <!-- 2. ADD PRODUCT -->
        <div id="add" class="section">
            <div class="card" style="max-width: 600px;">
                <h3>Add New Product</h3><br>
                <form id="addForm">
                    <label>Product Name</label>
                    <input type="text" id="pName" placeholder="e.g. Anime Hoodie" required>
                    
                    <label>Price ($)</label>
                    <input type="number" id="pPrice" placeholder="50" required>
                    
                    <label>Image Direct Link</label>
                    <input type="url" id="pImg" placeholder="https://i.ibb.co/..." required>
                    
                    <label>Tag (Optional)</label>
                    <input type="text" id="pTag" placeholder="e.g. Sale / Hot / New">
                    
                    <button type="submit" class="btn">Publish Product</button>
                </form>
            </div>
        </div>

        <!-- 3. MANAGE ORDERS -->
        <div id="orders" class="section">
            <div class="card">
                <h3>Recent Orders</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Customer</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="orderTable">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 4. TICKETS -->
        <div id="tickets" class="section">
            <div class="card">
                <h3>Support Inbox</h3>
                <div id="ticketList"></div>
            </div>
        </div>

        <!-- 5. SETTINGS (MARQUEE) -->
        <div id="settings" class="section">
            <div class="card" style="max-width: 600px;">
                <h3>ðŸ“¢ Announcement Bar Settings</h3>
                <p style="color:#888; font-size:0.9rem; margin-bottom:20px;">Control the scrolling text on the user dashboard.</p>
                
                <label>Announcement Text</label>
                <input type="text" id="marqText" placeholder="e.g. Flash Sale! 50% Off Everything">
                
                <div style="display:flex; align-items:center; gap:15px; margin: 20px 0; background:#f9f9f9; padding:15px; border-radius:10px;">
                    <label class="switch">
                        <input type="checkbox" id="marqCheck">
                        <span class="slider"></span>
                    </label>
                    <span style="font-weight:500;">Enable Marquee on App</span>
                </div>
                
                <button onclick="saveSettings()" class="btn">Update App Settings</button>
            </div>
        </div>

    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ðŸ”¥ YOUR CONFIG KEYS ðŸ”¥
        const firebaseConfig = {
            apiKey: "AIzaSyCo6W6Tzze5IvgcblQGvRssZcIUNlS9gQ0",
            authDomain: "waisi-store.firebaseapp.com",
            databaseURL: "https://waisi-store-default-rtdb.firebaseio.com",
            projectId: "waisi-store",
            storageBucket: "waisi-store.firebasestorage.app",
            messagingSenderId: "670605149716",
            appId: "1:670605149716:web:1c3becc5e7aa4c9b328901"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- NAVIGATION ---
        window.nav = (id, el) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
            el.classList.add('active');
            
            document.getElementById('pageTitle').innerText = el.innerText;
        }

        // --- 1. DASHBOARD STATS ---
        onSnapshot(collection(db, "users"), s => document.getElementById('c-users').innerText = s.size);
        onSnapshot(collection(db, "orders"), s => document.getElementById('c-orders').innerText = s.size);
        onSnapshot(collection(db, "tickets"), s => document.getElementById('c-tickets').innerText = s.size);

        // --- 2. ADD PRODUCT ---
        document.getElementById('addForm').addEventListener('submit', async(e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.innerText = "Publishing...";
            try {
                await addDoc(collection(db, "products"), {
                    name: document.getElementById('pName').value,
                    price: Number(document.getElementById('pPrice').value),
                    image: document.getElementById('pImg').value,
                    tag: document.getElementById('pTag').value,
                    createdAt: new Date()
                });
                alert("Product Added Successfully!");
                e.target.reset();
            } catch(err) { alert(err.message); }
            btn.innerText = "Publish Product";
        });

        // --- 3. MANAGE ORDERS ---
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), snap => {
            const tb = document.getElementById('orderTable');
            tb.innerHTML = "";
            snap.forEach(d => {
                const o = d.data();
                tb.innerHTML += `
                    <tr>
                        <td>
                            <div style="font-weight:600">${o.productName}</div>
                            <div style="font-size:0.8rem; color:#888;">#${d.id.substr(0,6)}</div>
                        </td>
                        <td>${o.fullName}<br><small>${o.phone}</small></td>
                        <td>$${o.total}</td>
                        <td><span class="badge st-${o.status}">${o.status}</span></td>
                        <td>
                            <select onchange="upOrder('${d.id}', this.value)" style="margin:0; padding:5px;">
                                <option disabled selected>Update</option>
                                <option value="Pending">Pending</option>
                                <option value="Processing">Processing</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </td>
                    </tr>`;
            });
        });
        window.upOrder = (id, s) => updateDoc(doc(db, "orders", id), {status:s});

        // --- 4. TICKETS SYSTEM ---
        onSnapshot(query(collection(db, "tickets"), orderBy("createdAt", "desc")), snap => {
            const div = document.getElementById('ticketList');
            div.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                div.innerHTML += `
                    <div style="border-bottom:1px solid #eee; padding:15px 0;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <strong>${t.userEmail}</strong>
                            <small style="color:#999">${t.createdAt?.toDate().toLocaleDateString()}</small>
                        </div>
                        <p style="background:#f9f9f9; padding:10px; border-radius:8px;">${t.message}</p>
                        ${!t.reply ? `
                        <div style="margin-top:10px; display:flex; gap:10px;">
                            <input id="r-${d.id}" placeholder="Type admin reply..." style="margin:0;">
                            <button class="btn" style="padding:8px 15px; width:auto;" onclick="reply('${d.id}')">Send</button>
                        </div>` 
                        : `<p style="margin-top:5px; color:var(--primary); font-size:0.9rem; padding-left:10px; border-left:2px solid var(--primary);"><strong>Admin:</strong> ${t.reply}</p>`}
                    </div>`;
            });
        });
        window.reply = (id) => updateDoc(doc(db, "tickets", id), {reply: document.getElementById('r-'+id).value});

        // --- 5. MARQUEE SETTINGS ---
        const mRef = doc(db, "settings", "marquee");
        // Load initial
        onSnapshot(mRef, s => {
            if(s.exists()) {
                document.getElementById('marqText').value = s.data().text || "";
                document.getElementById('marqCheck').checked = s.data().isEnabled || false;
            }
        });
        // Save
        window.saveSettings = async () => {
            try {
                await setDoc(mRef, {
                    text: document.getElementById('marqText').value,
                    isEnabled: document.getElementById('marqCheck').checked
                });
                alert("App Settings Updated!");
            } catch(e) { alert("Error: " + e.message); }
        }

    </script>
</body>
</html>
